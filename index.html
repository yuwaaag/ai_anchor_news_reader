<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>PTN News Live - Visual Loop Fix</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
        .studio { position: relative; width: 100vw; height: 100vh; background: url('studio.jpg') center/cover no-repeat; }
        .visual-box { 
            position: absolute; right: 4%; top: 10%; width: 42%; height: 40%; 
            border: 4px solid #00f2ff; border-radius: 12px; overflow: hidden; 
            box-shadow: 0 0 25px rgba(0, 242, 255, 0.6); z-index: 2; background: #000;
        }
        #newsImg { width: 100%; height: 100%; object-fit: cover; opacity: 1; transition: opacity 0.5s; }
        .script-window { 
            position: absolute; left: 4%; top: 10%; width: 40%; height: 55%; 
            background: rgba(0, 0, 0, 0.7); border-left: 8px solid #ff0000; 
            padding: 25px; box-sizing: border-box; z-index: 2; overflow: hidden;
        }
        #teleprompter { position: relative; font-size: 28px; line-height: 1.6; color: #fff; top: 100%; }
        .anchor-box { 
            position: absolute; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; 
            display: flex; justify-content: flex-end; align-items: flex-end; z-index: 10; pointer-events: none; 
        }
        #anchorCanvas { max-width: 62%; max-height: 94%; object-fit: contain; margin-bottom: -5px; }
        #hiddenVid { display: none; }
        .ticker-bar { 
            position: absolute; bottom: 0; width: 100%; height: 80px; 
            background: linear-gradient(90deg, #ff0000, #800000); 
            display: flex; align-items: center; z-index: 20; border-top: 4px solid #fff; 
        }
        marquee { font-size: 34px; font-weight: bold; color: white; width: 100%; }
    </style>
</head>
<body>

<div class="studio">
    <div class="visual-box"><img id="newsImg" src=""></div>
    <div class="script-window"><div id="teleprompter">‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç...</div></div>
    <div class="anchor-box"><canvas id="anchorCanvas"></canvas></div>
    <video id="hiddenVid" muted loop crossorigin="anonymous"><source src="anchor_video.mp4" type="video/mp4"></video>
    <div class="ticker-bar"><marquee scrollamount="12" id="flashTicker">PTN NEWS</marquee></div>
</div>

<script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZcfTxhcB7LltOPkXuTBsQ4CRNa2KZfb6EQ2lxx-eXFVhACj3YI4mH4tSeTSx-K_Wf1sgk0419ZDkf/pub?output=csv"; 

    let newsItems = [];
    let newsIndex = 0;
    let visualTimer = null;

    const video = document.getElementById('hiddenVid');
    const canvas = document.getElementById('anchorCanvas');
    const ctx = canvas.getContext('2d');
    const imgElement = document.getElementById("newsImg");

    function renderChroma() {
        if (video.paused) return;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < frame.data.length / 4; i++) {
            let r = frame.data[i * 4 + 0], g = frame.data[i * 4 + 1], b = frame.data[i * 4 + 2];
            if (g > 95 && g > r * 1.3 && g > b * 1.3) { frame.data[i * 4 + 3] = 0; }
        }
        ctx.putImageData(frame, 0, 0);
        requestAnimationFrame(renderChroma);
    }

    // üü¢ ‡§á‡§Æ‡•á‡§ú ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï‡§¶‡§Æ ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï
    function refreshImage(word) {
        const cleanWord = word ? word.trim() : "news";
        const randomID = Math.floor(Math.random() * 50000);
        
        imgElement.style.opacity = "0"; // ‡§´‡•ã‡§ü‡•ã ‡§ó‡§æ‡§Ø‡§¨ ‡§ï‡§∞‡•ã

        // ‡§®‡§Ø‡§æ URL ‡§∏‡•ã‡§∞‡•ç‡§∏
        const newSrc = `https://loremflickr.com/800/450/${encodeURIComponent(cleanWord)}?random=${randomID}`;
        
        // ‡§á‡§Æ‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•ã
        const checker = new Image();
        checker.src = newSrc;
        checker.onload = () => {
            imgElement.src = newSrc;
            imgElement.style.opacity = "1"; // ‡§´‡•ã‡§ü‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§ì
        };
    }

    async function getNews() {
        try {
            const res = await fetch(csvUrl);
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            newsItems = rows.map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { script: c[0]?.replace(/"/g,""), visual: c[1]?.replace(/"/g,""), flash: c[2]?.replace(/"/g,"") };
            }).filter(i => i.script);
            if(newsItems.length > 0) runBroadcast();
        } catch(e) { alert("Sheet Link Error!"); }
    }

    function runBroadcast() {
        // 1. ‡§™‡§ø‡§õ‡§≤‡§æ ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§∏‡§æ‡•û ‡§ï‡§∞‡•ã
        if (visualTimer) clearInterval(visualTimer);
        window.speechSynthesis.cancel();

        const currentNews = newsItems[newsIndex];
        const prompter = document.getElementById("teleprompter");

        // 2. UI ‡§î‡§∞ ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§°‡•á‡§ü
        prompter.style.transition = "none";
        prompter.style.top = "100%";
        prompter.innerText = currentNews.script;
        document.getElementById("flashTicker").innerText = "BREAKING: " + currentNews.flash;
        
        // ‡§™‡§π‡§≤‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§≤‡•ã‡§° ‡§ï‡§∞‡•ã
        refreshImage(currentNews.visual);

        // 3. ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§´‡•ã‡§ü‡•ã ‡§¨‡§¶‡§≤‡§§‡•á ‡§∞‡§π‡•ã
        visualTimer = setInterval(() => {
            refreshImage(currentNews.visual);
        }, 15000);

        // 4. ‡§Ü‡§µ‡§æ‡•õ ‡§î‡§∞ ‡§è‡§Ç‡§ï‡§∞
        const msg = new SpeechSynthesisUtterance(currentNews.script);
        msg.lang = 'hi-IN';
        msg.rate = 0.9;

        msg.onstart = () => {
            video.play();
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            renderChroma();
            setTimeout(() => {
                const scrollDur = currentNews.script.length * 0.13;
                prompter.style.transition = `top ${scrollDur}s linear`;
                prompter.style.top = `-${prompter.offsetHeight + 100}px`;
            }, 100);
        };

        msg.onend = () => {
            video.pause();
            clearInterval(visualTimer); // ‡§´‡•ã‡§ü‡•ã ‡§¨‡§¶‡§≤‡§®‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•ã
            newsIndex = (newsIndex + 1) % newsItems.length; // ‡§Ö‡§ó‡§≤‡•Ä ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§™‡§∞ ‡§ú‡§æ‡§ì
            setTimeout(runBroadcast, 2500); // 2.5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§¨‡§æ‡§¶ ‡§Ö‡§ó‡§≤‡•Ä ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§∂‡•Å‡§∞‡•Ç
        };

        window.speechSynthesis.speak(msg);
    }

    window.onclick = () => { if(newsItems.length === 0) getNews(); };
</script>
</body>
</html>
