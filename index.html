<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>PTN News - Zero Failure Edition</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        .studio { position: relative; width: 100vw; height: 100vh; background: url('studio.jpg') center/cover no-repeat; }
        .visual-box { position: absolute; right: 4%; top: 10%; width: 42%; height: 40%; border: 4px solid #00f2ff; border-radius: 12px; overflow: hidden; background: #000; box-shadow: 0 0 20px #00f2ff; }
        #newsImg { width: 100%; height: 100%; object-fit: cover; }
        .script-window { position: absolute; left: 4%; top: 10%; width: 40%; height: 55%; background: rgba(0,0,0,0.7); border-left: 8px solid #f00; padding: 20px; overflow: hidden; }
        #teleprompter { position: relative; font-size: 28px; color: #fff; top: 100%; line-height: 1.5; }
        .anchor-box { position: absolute; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; display: flex; justify-content: flex-end; align-items: flex-end; pointer-events: none; z-index: 5; }
        #anchorCanvas { max-width: 62%; max-height: 94%; margin-bottom: -5px; }
        .ticker-bar { position: absolute; bottom: 0; width: 100%; height: 80px; background: red; border-top: 4px solid #fff; display: flex; align-items: center; z-index: 10; }
        marquee { font-size: 32px; font-weight: bold; color: #fff; }
    </style>
</head>
<body>

<div class="studio" id="mainStudio">
    <div class="visual-box"><img id="newsImg" src=""></div>
    <div class="script-window"><div id="teleprompter">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div></div>
    <div class="anchor-box"><canvas id="anchorCanvas"></canvas></div>
    <video id="hiddenVid" muted loop crossorigin="anonymous" style="display:none;"><source src="anchor_video.mp4" type="video/mp4"></video>
    <div class="ticker-bar"><marquee id="flashTicker">PTN NEWS LIVE</marquee>marquee></div>
</div>

<script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZcfTxhcB7LltOPkXuTBsQ4CRNa2KZfb6EQ2lxx-eXFVhACj3YI4mH4tSeTSx-K_Wf1sgk0419ZDkf/pub?output=csv";

    // üü¢ ‡§™‡•á‡§ú ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§®‡§Ç‡§¨‡§∞ ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è "SessionStorage"
    let newsIndex = parseInt(sessionStorage.getItem('lastNewsIndex')) || 0;
    let newsItems = [];

    const video = document.getElementById('hiddenVid');
    const canvas = document.getElementById('anchorCanvas');
    const ctx = canvas.getContext('2d');

    function renderChroma() {
        if (video.paused) return;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < frame.data.length / 4; i++) {
            if (frame.data[i*4+1] > 100 && frame.data[i*4+1] > frame.data[i*4]*1.2) frame.data[i*4+3] = 0;
        }
        ctx.putImageData(frame, 0, 0);
        requestAnimationFrame(renderChroma);
    }

    async function startStudio() {
        const res = await fetch(csvUrl);
        const text = await res.text();
        const rows = text.split('\n').slice(1);
        newsItems = rows.map(r => {
            const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            return { script: c[0]?.replace(/"/g,""), visual: c[1]?.replace(/"/g,""), flash: c[2]?.replace(/"/g,"") };
        }).filter(i => i.script);

        if(newsIndex >= newsItems.length) newsIndex = 0; // ‡§≤‡•Ç‡§™ ‡§ñ‡§§‡•ç‡§Æ ‡§§‡•ã ‡§∂‡•Å‡§∞‡•Ç ‡§∏‡•á
        playCurrentNews();
    }

    function playCurrentNews() {
        const current = newsItems[newsIndex];
        const img = document.getElementById("newsImg");
        const prompter = document.getElementById("teleprompter");

        // 1. ‡§µ‡§ø‡§ú‡•Å‡§Ö‡§≤ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§π‡§Æ‡•á‡§∂‡§æ "‡§™‡§π‡§≤‡§æ" ‡§µ‡§ø‡§ú‡•Å‡§Ö‡§≤)
        const kw = encodeURIComponent(current.visual || "news");
        img.src = `https://loremflickr.com/800/450/${kw}?v=${Date.now()}`;
        
        prompter.innerText = current.script;
        document.getElementById("flashTicker").innerText = "PTN BREAKING: " + current.flash;

        const speech = new SpeechSynthesisUtterance(current.script);
        speech.lang = 'hi-IN';
        speech.rate = 0.9;

        speech.onstart = () => {
            video.play();
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            renderChroma();
            setTimeout(() => {
                prompter.style.transition = `top ${current.script.length * 0.13}s linear`;
                prompter.style.top = `-${prompter.offsetHeight + 100}px`;
            }, 100);
        };

        speech.onend = () => {
            // üü¢ ‡§Æ‡§æ‡§∏‡•ç‡§ü‡§∞ ‡§ü‡•ç‡§∞‡§ø‡§ï: ‡§Ö‡§ó‡§≤‡•Ä ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•ã ‡§î‡§∞ ‡§™‡•á‡§ú ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞ ‡§¶‡•ã!
            sessionStorage.setItem('lastNewsIndex', newsIndex + 1);
            location.reload(); 
        };

        window.speechSynthesis.speak(speech);
    }

    // ‡§ë‡§ü‡•ã-‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü ‡§Ö‡§ó‡§∞ ‡§™‡•á‡§ú ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•ã
    window.onclick = () => { startStudio(); };
    if(sessionStorage.getItem('lastNewsIndex')) {
        // ‡§Ö‡§ó‡§∞ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§π‡•ã‡§ï‡§∞ ‡§Ü‡§Ø‡§æ ‡§π‡•à ‡§§‡•ã ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å ‡§ï‡§ø ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç (‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è)
        document.getElementById("teleprompter").innerText = "‡§Ö‡§ó‡§≤‡•Ä ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à... ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§";
    }
</script>
</body>
</html>
