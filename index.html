<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>PTN News - 100% Guaranteed Fix</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        .studio { position: relative; width: 100vw; height: 100vh; background: url('studio.jpg') center/cover no-repeat; }
        
        /* ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤ ‡§¨‡•â‡§ï‡•ç‡§∏ */
        #visualBoxContainer { 
            position: absolute; right: 4%; top: 10%; width: 42%; height: 40%; 
            border: 4px solid #00f2ff; border-radius: 12px; overflow: hidden; 
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.5); z-index: 2; background: #000;
        }

        .script-window { position: absolute; left: 4%; top: 10%; width: 40%; height: 55%; background: rgba(0, 0, 0, 0.8); border-left: 8px solid #ff0000; padding: 30px; box-sizing: border-box; z-index: 2; overflow: hidden; }
        #teleprompter { position: relative; font-size: 30px; line-height: 1.6; color: #fff; top: 100%; font-weight: 500; }
        .anchor-box { position: absolute; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; display: flex; justify-content: flex-end; align-items: flex-end; z-index: 10; pointer-events: none; }
        #anchorCanvas { max-width: 60%; max-height: 90%; object-fit: contain; margin-bottom: -5px; }
        #hiddenVid { display: none; }
        .ticker-bar { position: absolute; bottom: 0; width: 100%; height: 80px; background: linear-gradient(90deg, #cc0000, #990000); display: flex; align-items: center; z-index: 20; border-top: 4px solid #fff; }
        marquee { font-size: 36px; font-weight: bold; color: white; }
    </style>
</head>
<body>

<div class="studio">
    <div id="visualBoxContainer"></div>
    <div class="script-window"><div id="teleprompter">PTN NEWS: ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç...</div></div>
    <div class="anchor-box"><canvas id="anchorCanvas"></canvas></div>
    <video id="hiddenVid" muted loop crossorigin="anonymous"><source src="anchor_video.mp4" type="video/mp4"></video>
    <div class="ticker-bar"><marquee id="flashTicker">PTN NEWS LIVE</marquee></div>
</div>

<script>
    // üî¥ ‡§Ö‡§™‡§®‡•Ä CSV ‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZcfTxhcB7LltOPkXuTBsQ4CRNa2KZfb6EQ2lxx-eXFVhACj3YI4mH4tSeTSx-K_Wf1sgk0419ZDkf/pub?output=csv"; 

    let newsItems = [];
    let currentIndex = 0;
    const video = document.getElementById('hiddenVid');
    const canvas = document.getElementById('anchorCanvas');
    const ctx = canvas.getContext('2d');

    // ‡§ï‡•ç‡§∞‡•ã‡§Æ‡§æ ‡§ï‡•Ä ‡§≤‡•â‡§ú‡§ø‡§ï
    function renderChroma() {
        if (video.paused) return;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < frame.data.length / 4; i++) {
            if (frame.data[i*4+1] > 95 && frame.data[i*4+1] > frame.data[i*4]*1.4) frame.data[i*4+3] = 0;
        }
        ctx.putImageData(frame, 0, 0);
        requestAnimationFrame(renderChroma);
    }

    // üü¢ ‡§Æ‡•õ‡§¨‡•Ç‡§§ ‡§µ‡§ø‡§ú‡•Å‡§Ö‡§≤ ‡§á‡§Ç‡§ú‡§®: ‡§ú‡•ã ‡§π‡§∞ ‡§¨‡§æ‡§∞ ‡§®‡§Ø‡§æ HTML ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§ó‡§æ
    function forceUpdateVisual(keyword) {
        const container = document.getElementById("visualBoxContainer");
        let cleanWord = keyword ? keyword.replace(/[^a-zA-Z0-9 ]/g, "").trim() : "breaking news";
        
        // ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§Æ‡§ø‡§ü‡§æ‡§ï‡§∞ ‡§®‡§Ø‡§æ ‡§ü‡•à‡§ó ‡§¨‡§®‡§æ‡§®‡§æ (‡§Ø‡§π‡•Ä ‡§ö‡§æ‡§¨‡•Ä ‡§π‡•à!)
        container.innerHTML = ""; 
        const newImg = document.createElement("img");
        newImg.style.width = "100%";
        newImg.style.height = "100%";
        newImg.style.objectFit = "cover";
        
        // ‡§∞‡•à‡§Ç‡§°‡§Æ ‡§Ü‡§à‡§°‡•Ä ‡§§‡§æ‡§ï‡§ø ‡§¨‡•ç‡§∞‡§æ‡§â‡•õ‡§∞ ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§® ‡§™‡§ï‡•ú‡•á
        const cacheBuster = Date.now();
        newImg.src = `https://loremflickr.com/800/450/${encodeURIComponent(cleanWord)}?random=${cacheBuster}`;
        
        container.appendChild(newImg);
    }

    async function loadNewsData() {
        try {
            // ‡§ó‡•Ç‡§ó‡§≤ ‡§∂‡•Ä‡§ü ‡§∏‡•á ‡§§‡§æ‡•õ‡§æ ‡§°‡•á‡§ü‡§æ ‡§ñ‡•Ä‡§Ç‡§ö‡§®‡§æ
            const res = await fetch(csvUrl + "?cb=" + Date.now());
            const data = await res.text();
            const rows = data.split('\n').slice(1);
            newsItems = rows.map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { 
                    script: c[0]?.replace(/"/g,"").trim(), 
                    visual: c[1]?.replace(/"/g,"").trim(), 
                    flash: c[2]?.replace(/"/g,"").trim() 
                };
            }).filter(i => i.script);
            
            if(newsItems.length) startNewsCycle();
        } catch(e) { console.error("Data load failed"); }
    }

    function startNewsCycle() {
        const item = newsItems[currentIndex];
        const prompter = document.getElementById("teleprompter");

        // 1. ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§î‡§∞ ‡§µ‡§ø‡§ú‡•Å‡§Ö‡§≤ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§¨‡§¶‡§≤‡•á‡§Ç
        prompter.style.transition = "none";
        prompter.style.top = "100%";
        prompter.innerText = item.script;
        document.getElementById("flashTicker").innerText = "PTN BREAKING: " + item.flash;
        
        // ‡§µ‡§ø‡§ú‡•Å‡§Ö‡§≤ ‡§ï‡•ã ‡§™‡§ï‡•ç‡§ï‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        forceUpdateVisual(item.visual);

        // 2. ‡§è‡§Ç‡§ï‡§∞ ‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡•õ
        window.speechSynthesis.cancel();
        const speech = new SpeechSynthesisUtterance(item.script);
        speech.lang = 'hi-IN';
        speech.rate = 0.9;

        speech.onstart = () => {
            video.play();
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            renderChroma();
            setTimeout(() => {
                const dur = item.script.length * 0.13;
                prompter.style.transition = `top ${dur}s linear`;
                prompter.style.top = `-${prompter.offsetHeight + 100}px`;
            }, 100);
        };

        speech.onend = () => {
            video.pause();
            // ‡§Ö‡§ó‡§≤‡•Ä ‡§®‡•ç‡§Ø‡•Ç‡•õ ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Å
            currentIndex = (currentIndex + 1) % newsItems.length;
            
            // ‡§Ö‡§ó‡§∞ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§™‡§π‡§≤‡•Ä ‡§®‡•ç‡§Ø‡•Ç‡•õ ‡§™‡§∞ ‡§Ü ‡§ó‡§è ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§°‡•á‡§ü‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
            if(currentIndex === 0) {
                loadNewsData(); 
            } else {
                setTimeout(startNewsCycle, 1500);
            }
        };

        window.speechSynthesis.speak(speech);
    }

    window.onclick = () => { if(!newsItems.length) loadNewsData(); };
</script>
</body>
</html>
